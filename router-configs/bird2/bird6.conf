# BIRD2 IPv6 Configuration for ORION Router (AS394955)
# Dell R730 - Router VM 200
# IPv6 Prefix: 2602:F674::/48
# Generated: 2025-01-22

log syslog all;
debug protocols { states, routes, filters, interfaces };

# Router ID (use IPv4 address as ID for both IPv4 and IPv6)
router id 100.64.0.1;

# Device protocol - learn interface information
protocol device {
    scan time 10;
}

# Direct protocol - learn directly connected networks
protocol direct {
    ipv6;
    interface "eth0", "eth1", "eth2", "eth3";
}

# Kernel protocol - sync routes with kernel routing table
protocol kernel kernel6 {
    ipv6 {
        import none;
        export all;
    };
    learn;
    persist;
    scan time 20;
    metric 100;
}

# Static routes
protocol static static6 {
    ipv6;

    # Announce our prefix (blackhole to prevent loops)
    route 2602:F674::/48 reject;

    # Specific subnets (will be directly connected)
    # These are learned via the direct protocol, but we keep them for reference
    # route 2602:F674:1000::/64 via "eth1";  # LAN
    # route 2602:F674:2000::/64 via "eth2";  # Guest
    # route 2602:F674:3000::/64 via "eth3";  # Management
}

# ============================================================================
# FILTER DEFINITIONS
# ============================================================================

# Outbound filter - what we announce to Telus
filter bgp_out_ipv6 {
    # Only announce our allocated prefix and more specific subnets
    if net ~ [ 2602:F674::/48{48,64} ] then {
        # Prepend our AS to the path
        bgp_path.prepend(394955);

        # Set communities (optional - adjust based on Telus requirements)
        # bgp_community.add((394955, 100));  # Example community

        accept;
    }

    # Reject everything else
    reject;
}

# Inbound filter - what we accept from Telus
filter bgp_in_ipv6 {
    # Accept default route
    if net = ::/0 then {
        accept;
    }

    # Accept global unicast addresses (2000::/3)
    if net ~ [ 2000::/3{0,64} ] then {
        accept;
    }

    # Reject our own prefix (should never receive this)
    if net ~ [ 2602:F674::/48+ ] then {
        print "Rejecting our own prefix from peer: ", net;
        reject;
    }

    # Reject bogon prefixes
    if net ~ [
        ::/0{0,7},          # Too short
        ::/8+,              # Loopback, etc.
        100::/8+,           # Discard
        2001::/32+,         # TEREDO
        2001:2::/48+,       # Benchmarking
        2001:10::/28+,      # ORCHID
        2001:db8::/32+,     # Documentation
        2002::/16+,         # 6to4
        3ffe::/16+,         # Old 6bone
        fc00::/7+,          # ULA
        fe80::/10+,         # Link-local
        fec0::/10+,         # Old site-local
        ff00::/8+           # Multicast
    ] then {
        print "Rejecting bogon prefix: ", net;
        reject;
    }

    # Accept everything else
    accept;
}

# ============================================================================
# BGP TEMPLATE FOR TELUS PEERS
# ============================================================================

template bgp telus_ipv6 {
    local as 394955;

    ipv6 {
        import filter bgp_in_ipv6;
        export filter bgp_out_ipv6;
        next hop self;
    };

    # BGP timers
    hold time 90;
    keepalive time 30;
    connect retry time 120;
    connect delay time 5;
    error wait time 60,300;

    # Enable graceful restart
    graceful restart on;
    graceful restart time 120;

    # Path selection
    path metric 1;

    # Disable MED comparison for multiple paths
    igp metric on;
}

# ============================================================================
# TELUS BGP PEERS (IPv6)
# ============================================================================

# Note: Replace these IPv6 addresses with actual Telus gateway addresses
# The addresses below are examples based on your IPv6 prefix allocation

# Telus BGP Peer 1 (Primary)
protocol bgp telus_peer1_v6 from telus_ipv6 {
    description "Telus Gateway 1 - IPv6 (Primary)";

    # TODO: Replace with actual Telus IPv6 gateway address
    # This is a placeholder - get actual address from Telus
    neighbor fe80::1 % 'eth0' as 6939;
    # Or if they provide global address:
    # neighbor 2602:F674:0000::ffff as 6939;

    source address 2602:F674:0000::1;

    ipv6 {
        import filter {
            # Prefer this peer (highest local preference)
            bgp_local_pref = 150;

            # Apply inbound filter
            if bgp_in_ipv6() then accept;
            reject;
        };
        export filter bgp_out_ipv6;
    };

    # Prefer routes from this peer
    preference 100;
}

# Telus BGP Peer 2 (Secondary)
protocol bgp telus_peer2_v6 from telus_ipv6 {
    description "Telus Gateway 2 - IPv6 (Secondary)";

    # TODO: Replace with actual Telus IPv6 gateway address
    neighbor fe80::2 % 'eth0' as 6939;
    # Or: neighbor 2602:F674:0000::fffe as 6939;

    source address 2602:F674:0000::1;

    ipv6 {
        import filter {
            # Lower preference than peer1
            bgp_local_pref = 100;

            if bgp_in_ipv6() then accept;
            reject;
        };
        export filter bgp_out_ipv6;
    };

    # Lower preference than peer 1
    preference 90;
}

# Telus BGP Peer 3 (Tertiary)
protocol bgp telus_peer3_v6 from telus_ipv6 {
    description "Telus Gateway 3 - IPv6 (Tertiary)";

    # TODO: Replace with actual Telus IPv6 gateway address
    neighbor fe80::3 % 'eth0' as 6939;
    # Or: neighbor 2602:F674:0000::fffd as 6939;

    source address 2602:F674:0000::1;

    ipv6 {
        import filter {
            # Lowest preference
            bgp_local_pref = 50;

            if bgp_in_ipv6() then accept;
            reject;
        };
        export filter bgp_out_ipv6;
    };

    # Lowest preference
    preference 80;
}

# ============================================================================
# BFD (Bidirectional Forwarding Detection) - Optional
# ============================================================================
# Uncomment if Telus supports BFD for faster failure detection

# protocol bfd {
#     interface "eth0" {
#         min rx interval 100 ms;
#         min tx interval 100 ms;
#         idle tx interval 300 ms;
#         multiplier 5;
#     };
# }

# ============================================================================
# NOTES
# ============================================================================
#
# 1. Update the neighbor addresses with actual Telus IPv6 gateway addresses
#    These should be provided by Telus during BGP setup
#
# 2. If using link-local addresses (fe80::), you must specify the interface
#    with % 'eth0' syntax
#
# 3. Verify BGP session status with:
#    birdc6 show protocols
#    birdc6 show protocols all telus_peer1_v6
#
# 4. Check received routes:
#    birdc6 show route protocol telus_peer1_v6
#
# 5. Check announced routes:
#    birdc6 show route export telus_peer1_v6
#
# 6. Test filters:
#    birdc6 eval 2602:F674::/48
#
